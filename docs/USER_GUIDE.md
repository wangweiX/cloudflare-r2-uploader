# 用户指南

本指南将帮助您快速上手 Cloudflare R2 图片上传插件。

## 目录

- [快速开始](#快速开始)
- [功能详解](#功能详解)
- [最佳实践](#最佳实践)
- [故障排除](#故障排除)
- [高级技巧](#高级技巧)

## 快速开始

### 1. 安装插件

1. 打开 Obsidian 设置（快捷键：`Cmd/Ctrl + ,`）
2. 进入「第三方插件」→「浏览」
3. 搜索「Cloudflare R2 Uploader」
4. 点击安装并启用

### 2. 部署 Worker

访问 [Cloudflare R2 Worker](https://github.com/wangweiX/cloudflare-r2-worker) 并按照说明部署。

关键步骤：
- 创建 R2 存储桶
- 设置 API 密钥
- 部署 Worker
- 记录 Worker URL

### 3. 配置插件

在 Obsidian 设置中找到插件配置：

必填项：
- **Worker URL**: 您的 Worker 地址
- **API Key**: 在 Worker 中设置的密钥
- **存储桶名称**: R2 存储桶名称

### 4. 开始使用

- 点击侧边栏的上传图标 📤
- 或使用命令面板（`Cmd/Ctrl + P`）

## 功能详解

### 📤 批量上传

**上传当前笔记的图片**
- 快捷方式：点击侧边栏图标
- 命令：「上传当前笔记中的图片」
- 功能：仅上传当前打开笔记中的本地图片

**上传所有笔记的图片**
- 命令：「上传所有笔记中的图片」
- 功能：扫描整个 Vault 并上传所有本地图片
- 注意：首次使用可能需要较长时间

### 📋 自动粘贴上传

1. 在设置中开启「启用自动粘贴上传」
2. 复制图片（截图或文件）
3. 在笔记中粘贴
4. 插件自动上传并插入云端链接

**工作流程**：
```
复制图片 → 粘贴到笔记 → 自动上传 → 替换为云端链接
```

### 🗑️ 本地文件管理

开启「上传成功后删除本地图片」后：
- ✅ 上传成功且链接更新后自动删除
- ❌ 上传失败或链接更新失败不会删除
- 📁 释放本地存储空间

### ⚡ 并发上传

调整「最大并发上传数」：
- 默认值：3
- 推荐值：5-10
- 最大值：50

**选择建议**：
- 网络较慢：1-3
- 普通网络：3-10
- 高速网络：10-50

## 最佳实践

### 1. 文件组织

**推荐的文件夹结构**：
```
/
├── obsidian/      # Obsidian 相关图片
├── blog/          # 博客图片
├── projects/      # 项目截图
└── archive/       # 归档图片
```

在设置中配置「文件夹名称」以实现分类存储。

### 2. 命名规范

插件会自动生成唯一文件名：
```
原始名称_时间戳_随机ID.扩展名
```

示例：`screenshot_1643712345678_a1b2c3d4.png`

### 3. 批量处理技巧

**大量图片上传**：
1. 提高并发数至 10-20
2. 确保网络稳定
3. 分批处理（按文件夹）

**避免重复上传**：
- 插件自动记录已上传文件
- 无需手动跟踪

### 4. 备份策略

建议：
- 定期备份 R2 存储桶
- 保留重要图片的本地副本
- 使用版本控制系统

## 故障排除

### 常见问题

#### 1. 上传失败：400 Bad Request

**原因**：文件类型不支持

**解决方案**：
- 检查 Worker 配置中的 `ALLOWED_CONTENT_TYPES`
- 确保包含所需的 MIME 类型
- 重新部署 Worker

#### 2. 上传失败：401 Unauthorized

**原因**：API Key 错误

**解决方案**：
- 检查插件设置中的 API Key
- 确保与 Worker 环境变量一致
- 注意前后空格

#### 3. 图片链接未更新

**原因**：链接格式不被识别

**解决方案**：
- 确保使用标准格式：`![alt](path)` 或 `![[path]]`
- 检查图片路径是否正确
- 查看控制台日志

#### 4. 网络超时

**原因**：文件过大或网络慢

**解决方案**：
- 增加「上传超时」时间
- 减少并发数
- 优化图片大小

### 日志查看

开启「显示详细日志」后：
1. 打开开发者工具（`Cmd/Ctrl + Shift + I`）
2. 切换到 Console 标签
3. 查看带有 `[Cloudflare R2 Uploader]` 前缀的日志

## 高级技巧

### 1. 自定义域名配置

如果您为 R2 配置了自定义域名：

1. 在 Cloudflare 中设置 CNAME
2. 在插件设置中填入完整域名
3. 格式：`https://images.yourdomain.com`

### 2. 性能优化

**图片优化**：
- 上传前压缩图片
- 使用 WebP 格式
- 控制图片尺寸

**网络优化**：
- 选择就近的 Cloudflare 数据中心
- 使用 Cloudflare CDN

### 3. 批量迁移

从其他图床迁移：
1. 导出原图床图片
2. 放入 Obsidian 附件文件夹
3. 运行「上传所有笔记中的图片」
4. 完成后可删除本地文件

### 4. API 集成

Worker 提供 RESTful API，可用于：
- 自动化脚本
- 第三方工具集成
- 批量管理

## 安全建议

1. **API Key 安全**
   - 使用强密码（32位以上）
   - 定期更换
   - 不要分享或公开

2. **存储桶权限**
   - 限制 Worker 权限
   - 启用访问日志
   - 定期审查

3. **备份重要数据**
   - 使用 R2 的版本控制
   - 定期导出重要图片
   - 多地备份

## 更多帮助

- 📖 [项目主页](https://github.com/wangweiX/obsidian-cloudflare-r2-uploader)
- 🐛 [报告问题](https://github.com/wangweiX/obsidian-cloudflare-r2-uploader/issues)
- 💬 [讨论区](https://github.com/wangweiX/obsidian-cloudflare-r2-uploader/discussions)

---

希望本指南能帮助您更好地使用插件！如有问题，欢迎在 GitHub 上提出。